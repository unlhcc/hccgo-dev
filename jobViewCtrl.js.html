<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>jobViewCtrl.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-writing-tutorials.html">Writing Tutorials</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.connectionService.html">connectionService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.connectionService.html#.runCommand">runCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.dataUsageService.html">dataUsageService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.dataUsageService.html#.getDataUsage">getDataUsage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.dbService.html">dbService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.dbService.html#.getJobHistoryDB">getJobHistoryDB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.dbService.html#.getSubmittedJobsDB">getSubmittedJobsDB</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.filePathService.html">filePathService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.filePathService.html#.getDataPath">getDataPath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.filePathService.html#.getJobHistory">getJobHistory</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.filePathService.html#.getPreferences">getPreferences</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.filePathService.html#.getSubmittedJobs">getSubmittedJobs</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.jobStatusService.html">jobStatusService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.jobStatusService.html#.addJobToDb">addJobToDb</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.jobStatusService.html#.refreshDatabase">refreshDatabase</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.jobViewCtrl.html">jobViewCtrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.jobViewCtrl.html#.copyToClipboard">copyToClipboard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.jobViewCtrl.html#.downloadRemoteFile">downloadRemoteFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.jobViewCtrl.html#.saveFile">saveFile</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.notifierService.html">notifierService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.notifierService.html#.error">error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.notifierService.html#.getWinFocus">getWinFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.notifierService.html#.success">success</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.notifierService.html#.warning">warning</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.updaterButtonCtrl.html">updaterButtonCtrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterButtonCtrl.html#.restartUpdate">restartUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterButtonCtrl.html#.setUpdate">setUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterButtonCtrl.html#.updateDialog">updateDialog</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HCCGo.updaterService.html">updaterService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterService.html#.getUpdateDetails">getUpdateDetails</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterService.html#.hasUpdate">hasUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterService.html#.start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HCCGo.updaterService.html#.updateRestart">updateRestart</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="jobService.html">jobService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="jobService.html#.addDBJob">addDBJob</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tutorialCtrl.html">tutorialCtrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tutorialCtrl.html#.getPackageJson">getPackageJson</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tutorialCtrl.html#.importSubmitScripts">importSubmitScripts</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#GenericClusterInterface">GenericClusterInterface</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">jobViewCtrl.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>jobViewModule = angular.module('HccGoApp.jobViewCtrl', ['ngRoute' ]);

/**
 * This controller is responsible for displaying the input, output, and error of a specific job.
 * The user is able to copy the output and error of a job up to 5MB.
 * They are also able to save the entire file to their local machines.
 * 
 * @ngdoc controller
 * @memberof HCCGo
 * @class jobViewCtrl
 * @requires $scope
 * @requires $log
 * @requires $timeout
 * @requires connectionService
 * @requires $routeParams
 * @requires $location
 * @requires $q
 * @requires preferencesManager
 * @requires notifierService
 * @requires jobService
 * @requires dbService
 */
jobViewModule.controller('jobViewCtrl', ['$scope', '$log', '$timeout', 'connectionService', '$routeParams', '$location', '$q', 'preferencesManager', 'notifierService', 'jobService', 'dbService', function($scope, $log, $timeout, connectionService, $routeParams, $location, $q, preferencesManager, notifierService, jobService, dbService) {

  $scope.params = $routeParams;

  // query the db for the specific job and check if out/err is loaded
  dbService.getSubmittedJobsDB().then(function(db) {
    var outDownload = true;
    var errDownload = true;
    db.find({_id: $routeParams.jobId}, function (err, docs) {
      var result = docs[0];
      if (err) {
        $log.error("Error querying the DB for job states");
      }
      else if (result.hasOwnProperty("outText") &amp;&amp; result.hasOwnProperty("errText")) {
        $scope.$apply(function() {
          $scope.job = result;
        });
      }
      else if (typeof result.outputPath == undefined) {
        result.outText = "Output file not loaded, please check back in a moment";
      } 
      else if (typeof result.errorPath == undefined) {
        result.errText = "Error file not loaded, please check back in a moment";
      }
      
      else {
        // In parallel, get the size of the output and error
        connectionService.getFileSize(result.outputPath).then(function(size) {
          // If the file is larger than 5MB
          if(size > 5*1025*1024) {
            result.outText = "The Output file is too large to be displayed here.";
            outDownload = false;
          } else {
            connectionService.getFileText(result.outputPath).then(function(data) {
              var text = data.length>0 ? data : "(none)";
              result.outText = text;
              outDownload = text != "(none)";
              db.update(
                { _id: $routeParams.jobId },
                { $set:
                  {
                  "outText": text,
                  "outDownload": outDownload
                  }
                },
                { returnUpdatedDocs: true },
                function (err, numReplaced, affectedDocuments) {
                  // update db with data so it doesn't have to be queried again
                  if (err) {
                    $log.debug("Something went wrong updating the db.");
                  }
                }
              );
            });
          }
        });


        connectionService.getFileSize(result.errorPath).then(function(size) {
          if(size > 5*1025*1024) {
            result.errText = "The Error file is too large to be displayed here.";
            errDownload = false;
          }
          else {
            connectionService.getFileText(result.errorPath).then(function(data) {
            var text = data.length>0 ? data : "(none)";
            result.errText = text;
            errDownload = result.errText != "(none)";
            // Only save the output if the job is marked complete
            if (result.complete) {
              db.update(
                { _id: $routeParams.jobId },
                { $set:
                  {
                  "errText": text,
                  "errDownload": errDownload
                  }
                },
                { returnUpdatedDocs: true },
                function (err, numReplaced, affectedDocuments) {
                  // update db with data so it doesn't have to be queried again
                  if (err) {
                    $log.debug("Something went wrong updating the db.");
                  }
                }
                );
                result.errDownload = errDownload;
                result.outDownload = outDownload;
              }
            });
          }
        });
      }
      $scope.$apply(function() {
          $scope.job = result;
      });
    });
  });

  /**
   * Saves the output or error to a file
   * @method saveFile
   * @memberof HCCGo.jobViewCtrl
   * @param {String} fileType - Denotes either the output or error to be Saved
   * @param {Event} $event - Used to stop the save event from moving up the DOM
   */
  $scope.saveFile = function(fileType, $event) {
    const {dialog} = require('electron').remote;
    const fs = require('fs');
    const path = require('path');

    var options = {
      filters: [
        { name: 'text', extensions: ['txt']}
      ]
    };

    dialog.showSaveDialog(options, function(localFile) {
      // If the user clicks cancel, localFile will be undefined
      if (!localFile) return;

      downloadRemoteFile($scope.job[fileType], localFile).then(function(flag) {
        if (!flag) {
          fs.writeFile(localFile, $scope.job[fileType], function(err) {});
        }
        notifierService.success(path.basename(localFile).trim() + " was Successfully Saved!", "Save Successful!");
      },
      function(err) {
        notifierService.error(msg);
      });
      
    });
    // Stop the propagation of the click
    $event.stopPropagation();
  };

  /**
   * Used to download the file requested from the server, since only 5MB worth of data is displayed to the user.
   * @method downloadRemoteFile
   * @memberof HCCGo.jobViewCtrl
   * @param {String} remotePath - Denotes the path on the server to download the file from
   * @param {String} localPath - Denotes the path where the user wants the file saved
   * @returns {Promise} A promise denoting whether the file was downloaded from the server or not.
   */
  function downloadRemoteFile(remotePath, localPath) {
    var deferred = $q.defer();

    connectionService.getFileSize(remotePath).then(function(size) {
      if (size > 5*1025*1024) {
        connectionService.quickDownload(remotePath, localPath).then(function(flag) {
          deferred.resolve(true);
        }, 
        function(err) {
            deferred.reject("Error downloading file!");  
        });
      }
      else {
        deferred.resolve(false);
      }
      $log.log(deferred);
    });
    return deferred.promise;
  }

  /**
   * Copies the contents of the displayed output or error to the system clipboard
   * @method copyToClipboard
   * @memberof HCCGo.jobViewCtrl
   * @param {String} fileType - Used to grab either output or error from the textarea
   * @param {Object} $event - Stops the copy event from traversing up the DOM
   */
  $scope.copyToClipboard = function(fileType, $event) {
    const {clipboard} = require('electron');
    clipboard.writeText($scope.job[fileType]);
    $event.stopPropagation();
    notifierService.success("Copied to Clipboard!", "Copied!");
  }
}]);
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Apr 20 2017 19:45:11 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
